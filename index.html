<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TronLink 连接调试</title>
</head>
<body>
  <h2>TronLink 连接调试</h2>
  <button id="connectBtn">连接钱包</button>
  <p id="status">状态：未连接</p>

  <script>
    async function connectWallet() {
      const statusEl = document.getElementById("status");
      console.log("connectWallet 被调用");

      // 检查 tronLink 对象
      console.log("window.tronLink:", window.tronLink);
      console.log("window.tronWeb:", window.tronWeb);

      if (window.tronLink && typeof window.tronLink.request === "function") {
        // TronLink 存在
        if (window.tronLink.ready) {
          statusEl.innerText = "已连接（已准备）";
          console.log("tronLink.ready = true，地址是", window.tronLink.tronWeb.defaultAddress.base58);
          return window.tronLink.tronWeb;
        } else {
          console.log("tronLink.ready = false，尝试发起请求");
          try {
            const res = await window.tronLink.request({
              method: "tron_requestAccounts",
              params: {
                websiteIcon: "",
                websiteName: ""
              }
            });
            console.log("tron_requestAccounts 返回:", res);
            if (res && res.code === 200) {
              statusEl.innerText = "连接成功";
              console.log("连接成功，地址:", window.tronLink.tronWeb.defaultAddress.base58);
              return window.tronLink.tronWeb;
            } else {
              statusEl.innerText = "连接失败: code = " + res.code;
              console.warn("连接请求未被授权或失败", res);
              return null;
            }
          } catch (err) {
            console.error("请求连接异常", err);
            statusEl.innerText = "连接异常：" + err.message;
            return null;
          }
        }
      } else {
        statusEl.innerText = "未检测到 TronLink 请求接口";
        console.error("window.tronLink 无法使用 request 方法");
        return null;
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectWallet);

    window.addEventListener("DOMContentLoaded", () => {
      console.log("页面加载完毕");
      // 不自动发起连接，用户点击触发
    });
  </script>
</body>
</html>
